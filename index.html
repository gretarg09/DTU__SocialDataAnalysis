<!DOCTYPE html>
    <html lang="en">
        <head>
            <meta charset="utf-8">
            <title>Project 2</title>
            <script type="text/javascript" src="d3/d3.js"></script>
            <link rel="stylesheet" href="style/myStyle.css">
        </head>

        <body>
            <!-- EXERCISE 1 -->
            <h2>Assignment 2A: One scatter plot and two datasets</h2>
            <p id="Visualization2_text">Text describing visualization 2</p>

            <p id="data2003" class="p_data_1">Data from 2003</p>
            <p id="data2015" class="p_data_1">Data from 2015</p>

            <div id="area1"></div>

            <!-- EXERCISE 2 -->

            <h2>Assignment 2B: Visualizing geodata </h2>
            <div id="area3"></div>
            <div> 
                <p id="knn2" class="p_knn">knn = 2</p>
                <p id="knn3" class="p_knn">knn = 3</p>
                <p id="knn4" class="p_knn">knn = 4</p>
                <p id="knn5" class="p_knn">knn = 5</p>
                <p id="knn6" class="p_knn">knn = 6</p>
            </div>


            <!-- EXERCISE 1 SCRIPT-->

            <script type="text/javascript"> 
                var dataset;  
                var dataset_2003;
                var dataset_2015;
                var data_displayed = 2013;
                var primaryColor = "rgba(135,206,235,1)"

                // Load file from json 
                d3.json("data/data1.json", function(error,json) {
                    if (error) {  //If error is not null, something went wrong.

                        console.log(error);  //Log the error.
                    } 
                    else { 
                        //If no error, the file loaded correctly. Yay!
                        console.log(json);   //Log the data.

                        //Include other code to execute after successful file load here
                        dataset = json;
                        dataset_2003 = json.Period2003;
                        dataset_2015 = json.Period2015;
                        console.log(dataset.Period2003);
                        console.log(dataset.Period2015);

                        //Width,height and padding
                        var w = 1000;
                        var h = 600;
                        var padding = 80;
                      
                        // Calculate maximum prostitute and vehicle value
                        max_prostitution = d3.max([
                            d3.max(dataset_2003, function(d) { console.log(d.prostitution); return parseInt(d.prostitution); }),
                            d3.max(dataset_2015, function(d) { console.log(d.prostitution); return parseInt(d.prostitution); })
                            ]);

                        max_vehicle = d3.max([
                            d3.max(dataset_2003, function(d) { console.log(d.vehicle); return parseInt(d.vehicle); }),
                            d3.max(dataset_2015, function(d) { console.log(d.vehicle); return parseInt(d.vehicle); })
                            ]);

                        console.log("Max prostitution:" + max_prostitution);
                        console.log("Max vehicle:" + max_vehicle);

                        // Setting the maximum circle radius. This will be used in the radius scaling
                        max_radius = 15;

                        //Create xScale function
                        var xScale = d3.scale.linear()
                            .domain([0, max_prostitution * 1.15])
                            .range([padding, w - padding * 2]);

                        //Create yScale function
                        var yScale = d3.scale.linear()
                            .domain([0, max_vehicle * 1.1])
                            .range([h - padding, padding]);

                        // Create radius scale function
                        var rScale = d3.scale.linear()
                            .domain([0, d3.max(dataset_2003, function(d) { console.log(d.total); return parseInt(d.total); })])
                            .range([0,max_radius]);

                        //Define X axis
                        var xAxis = d3.svg.axis()
                            .scale(xScale)
                            .orient("bottom")
                            .ticks(8);

                        //Define Y axis
                        var yAxis = d3.svg.axis()
                                    .scale(yScale)
                                    .orient("left")
                                    .ticks(8);

                        //Create SVG element
                        var svg1 = d3.select("#area1")
                            .append("svg")
                            .attr("width", w)
                            .attr("height", h);

                        //Define clipping path
                        svg1.append("clipPath")
                            .attr("id", "chart-area")
                            .append("rect")
                            .attr("x", padding)
                            .attr("y", padding)
                            .attr("width", w - padding * 3)
                            .attr("height", h - padding * 2);

                        //Create circles
                        svg1.append("g")
                            .attr("id", "circles")
                            .attr("clip-path", "url(#chart-area)")
                            .selectAll("circle")
                            .data(dataset_2003)
                            .enter()
                            .append("circle")
                            .attr("cx", function(d) {
                                return xScale(d.prostitution);
                            })
                            .attr("cy", function(d) {
                                return yScale(d.vehicle);
                            })
                            .attr("r", function(d) {
                                 return rScale(d.total);
                            });
                      
                        //Create X axis
                        svg1.append("g")
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + (h - padding) + ")")
                            .call(xAxis);
                      
                        //Create Y axis
                        svg1.append("g")
                            .attr("class", "y axis")
                            .attr("transform", "translate(" + padding + ",0)")
                            .call(yAxis);
                      
                        // Adding text values above each circle
                        svg1.append("g")
                            .attr("id", "texts")
                            .attr("clip-path", "url(#chart-area)")
                            .selectAll("text")
                            .data(dataset_2003)
                            .enter()
                            .append("text")
                            .attr("class", "labels")
                            .text(function(d) {
                                return d.District;
                            })
                            .attr("x", function(d) {
                                return xScale(d.prostitution);
                            })
                            .attr("y", function(d) {
                                 return yScale(d.vehicle);
                            })
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "10px")
                            .attr("fill", primaryColor);


                        // now add titles to the axes
                        svg1.append("text")
                            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                            .attr("transform", "translate("+ (padding/3) +","+(h/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
                            .text("Vehicle theft");

                        svg1.append("text")
                            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                            .attr("transform", "translate("+ (w/2) +","+(h-(padding/3))+")")  // centre below axis
                            .text("Prostitution");

                        // Set corresponding color on p
                        d3.selectAll("p").filter("#data2003").style("color",primaryColor);

                        // Create the toggle functionality. When p is pressed we update the dataset and start a transition from one dataset to the other
                        d3.selectAll("p")
                            .filter(".p_data_1")
                            .on("click", function() {

                            // Get button 2003 and 2015
                            var p_2003 = d3.selectAll("p").filter("#data2003");
                            var p_2015 = d3.selectAll("p").filter("#data2015"); 

                            var paragraphID = d3.select(this).attr("id");
                            var chosenDataset;

                            if(paragraphID == "data2003"){
                                chosenDataset = dataset_2003;
                                p_2003.style("color", primaryColor);
                                p_2015.style("color", "black");
                                console.log("2003 button pressed")
                            }
                            else {
                                chosenDataset = dataset_2015;
                                p_2003.style("color", "black");
                                p_2015.style("color", primaryColor);
                                console.log("2015 button pressed")
                            }
                            
                            // Set transition duration
                            var transition_duration = 1000;

                            // Update radius scaling
                            rScale.domain([0, d3.max(chosenDataset, function(d) { return parseInt(d.total); })]);

                            //Update all circles
                            svg1.selectAll("circle")
                                .data(chosenDataset)
                                .transition()
                                .duration(transition_duration)
                                .attr("cx", function(d) {
                                    return xScale(d.prostitution);
                                })
                                .attr("cy", function(d) {
                                    return yScale(d.vehicle);
                                })
                                .attr("r", function(d) {
                                    return rScale(d.total);
                                });

                            //Update all Text
                            svg1.selectAll("text")
                                .filter(".labels")
                                .data(chosenDataset)
                                .transition()
                                .duration(transition_duration)
                                .attr("x", function(d) {
                                    return xScale(d.prostitution);
                                })
                                .attr("y", function(d) {
                                    return yScale(d.vehicle);
                                });
                        });
                    }
                });
            </script>


            <!-- EXERCISE 2 SCRIPT -->

            <script type="text/javascript"> 
                //Width and height
                var w = 800;
                var h = 600;
                var k = 2;
                var  data_2;
                var locations;

                var primaryColor = "rgba(135,206,235,1)"

                var projection = d3.geo.mercator()
                    .center([-122.433701, 37.767683])
                    .scale(200000)
                    .translate([w / 2, h / 2]);

                //Define path generator
                var path = d3.geo.path()
                    .projection(projection);

                //Define quantize scale to sort data values into buckets of color
                var color = d3.scale.quantize()
                    .domain(d3.range(6))
                    // dark green, burgendy, dark blue, mustart yellow, dark grey, sky blue
                    .range(["#003C00","#800020","#210860","#999900","#666666","#87ceeb"]);

                //Define quantize scale to sort data values into buckets of color for mean value data points
                var mean_color = d3.scale.quantize()
                    .domain(d3.range(6))
                    // dark green, burgendy, dark blue, mustart yellow, dark grey, sky blue
                    .range(["#002A00","#400010","#100430","#4c4c00","#474747","#517B8D"]);

                //Create SVG element
                var svg = d3.select("#area3")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

                //Load in GeoJSON data
                d3.json("https://raw.githubusercontent.com/suneman/socialdataanalysis2017/master/files/sfpddistricts.geojson", function(json){
                //d3.json("us-states.json", function(json) {                    
                    //Bind data and create one path per GeoJSON feature
                    svg.selectAll("path")
                        .data(json.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .style("fill", "#E6E6E6")
                        .attr('stroke-width',0.5)
                        .attr('stroke',"#626262");

                    // Read in the dataset for visualization 2
                    d3.json("data/data2.json", function(error,json) {
                        if (error) {  //If error is not null, something went wrong.
                            console.log(error);  //Log the error.
                        } 
                        else {  
                            //If no error, the file loaded correctly. Yay!

                            /*
                             Note that we check the type of d in each function(d).
                             The reason being that we append the mean lat and lon values for each class in the end of data_2.knn#.data
                             so our data_2.knn#.data will have the following format:
                                class# : [
                                    number,
                                    number,
                                    number,
                                    .
                                    .
                                    .,
                                    number,
                                    array of length 3 [class,lat,lon],
                                    array of length 3 [class,lat,lon],
                                ]
                             */

                            // Saving the data in the data_2 variable
                            data_2 = json;
                            console.log(data_2);
                            locations = data_2.locations;
                            
                            //Create circles for each observation
                            svg.selectAll("circle")
                                .data(data_2.knn2.data)
                                .enter()
                                .append("circle")
                                .attr("cx", function(d,i) { return projection(get_lonlat_pair(d,i,locations))[0];})
                                .attr("cy", function(d,i) {return projection(get_lonlat_pair(d,i,locations))[1];})
                                .attr("r",function(d){ return get_radius(d); })
                                .style("fill", function(d) {return get_color(d);})
                                .attr("class",function(d){ return get_class(d); })
                                .style("opacity", 0.75);

                            // Create the toggle function
                            d3.selectAll("p").filter("#knn2").style("color",primaryColor);

                            // p button click event handler
                            d3.selectAll("p")
                                .filter(".p_knn")
                                .on("click", function() {

                                    // Set color on knn_p
                                    setcolor_knn_p();
                                    var paragraphID = d3.select(this).attr("id");
                                    d3.selectAll("p")
                                        .filter("#"+paragraphID)
                                        .style("color", primaryColor);

                                    // Update data
                                    var class_data = getdata_by_class_knn(data_2, paragraphID);
                                    console.log(class_data);

                                    // Select all circles
                                    var circles = svg.selectAll("circle")
                                        .data(class_data.data);

                                    // Create circles for new data points
                                    // This will only be class mean data points
                                    circles.enter()
                                        .append("circle")
                                        .style("opacity", 0.75);

                                    //Update all circles
                                    circles.attr("cx", function(d,i) { return projection(get_lonlat_pair(d,i,locations))[0];})
                                        .attr("cy", function(d,i) { return projection(get_lonlat_pair(d,i,locations))[1]; })
                                        .attr("r",function(d){ return get_radius(d); })
                                        .attr("class",function(d){ return get_class(d); })
                                        //.transition()
                                        //.duration(300)
                                        .style("fill", function(d) { return get_color(d);})
                                        .style("opacity", 0.75);

                                    // Remove class mean data points
                                    circles.exit()
                                        .remove();
                                });
                        }   
                    });
                });
                
                // The function returns longitute latitute value pairs
                function get_lonlat_pair(d,i,locations){
                    var lat;
                    var lon;
                    if(typeof(d) == "number" ){
                        lat = locations[i][0];
                        lon = locations[i][1];
                        
                    }
                    else{
                        lat = d[1];
                        lon = d[2];
                    }
                    return [lon,lat];
                }dat

                // The function returns the circle radius for each observation. If the observation is a mean datapoint (observation) then 
                // it should receive 4 times the normal radius. We want the mean data point's circles to be bigger.
                function get_radius(d){
                    if(typeof(d) == "number" ){
                        return 3;
                    }
                    else{
                        return 4*4;
                    }
                }

                // This function divides the circles into two classes. Either a normal knn_class observation or a mean_circle observation
                function get_class(d){
                    if(typeof(d) == "number" ){
                        return "knn_class" + d.toString();
                    }
                    else{
                        return "mean_circles";
                    }
                }

                // Return appropriate color for each data point
                function get_color (d){
                    if(typeof(d) == "number" ){
                        return color(d);
                    }
                    else{
                        return mean_color(d[0]);
                    }
                }

                // Sets the text color of each p as black. 
                function setcolor_knn_p() {
                    d3.selectAll("p")
                        .filter(".p_knn")
                        .style("color", "black");
                }

                // Returns the datasets class
                function getdata_by_class_knn(data,knn_class){
                    if(knn_class == "knn2"){
                        return data.knn2;
                    }
                    if(knn_class == "knn3"){
                        return data.knn3;
                    }
                    if(knn_class == "knn4"){
                        return data.knn4;
                    }
                    if(knn_class == "knn5"){
                        return data.knn5;
                    }
                    if(knn_class == "knn6"){
                        return data.knn6;
                    }
                }
            </script>
        </body>
</html>