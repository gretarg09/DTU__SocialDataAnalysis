<!DOCTYPE html>
    <html lang="en">
        <head>
            <meta charset="utf-8">
            <title>Project 2</title>
            <script type="text/javascript" src="d3/d3.js"></script>
            <link rel="stylesheet" href="style/myStyle.css">
        </head>

        <body>
            <!-- EXERCISE 1 -->
            <h2>Assignment 2A: One scatter plot and two datasets</h2>
            <p id="Visualization2_text">Text describing visualization 2</p>

            <p id="data2003" class="p_data_1">Data from 2003</p>
            <p id="data2015" class="p_data_1">Data from 2015</p>

            <div id="area1"></div>

            <!-- EXERCISE 2 -->

            <h2>Assignment 2B: Visualizing geodata </h2>
            <div id="area3"></div>
            <div> 
                <p id="knn2" class="p_knn">knn = 2</p>
                <p id="knn3" class="p_knn">knn = 3</p>
                <p id="knn4" class="p_knn">knn = 4</p>
                <p id="knn5" class="p_knn">knn = 5</p>
                <p id="knn6" class="p_knn">knn = 6</p>
            </div>


            <!-- EXERCISE 1 SCRIPT-->

            <script type="text/javascript"> 
                var dataset;  
                var dataset_2003;
                var dataset_2015;
                var data_displayed = 2013;
                var primaryColor = "rgba(135,206,235,1)"

                // Load file from json 
                d3.json("data/data1.json", function(error,json) {
                    if (error) {  //If error is not null, something went wrong.

                        console.log(error);  //Log the error.
                    } 
                    else { 
                        //If no error, the file loaded correctly. Yay!
                        console.log(json);   //Log the data.

                        //Include other code to execute after successful file load here
                        dataset = json;
                        dataset_2003 = json.Period2003;
                        dataset_2015 = json.Period2015;
                        console.log(dataset.Period2003);
                        console.log(dataset.Period2015);

                        //Width and height
                        var w = 1000;
                        var h = 600;
                        var padding = 80;
                      
                        // Calculate maximum prostitute and vehicle value
                        max_prostitution = d3.max([
                            d3.max(dataset_2003, function(d) { console.log(d.prostitution); return parseInt(d.prostitution); }),
                            d3.max(dataset_2015, function(d) { console.log(d.prostitution); return parseInt(d.prostitution); })
                            ]);

                        max_vehicle = d3.max([
                            d3.max(dataset_2003, function(d) { console.log(d.vehicle); return parseInt(d.vehicle); }),
                            d3.max(dataset_2015, function(d) { console.log(d.vehicle); return parseInt(d.vehicle); })
                            ]);

                        console.log("Max prostitution:" + max_prostitution);
                        console.log("Max vehicle:" + max_vehicle);


                        max_radius = 10;

                        //Create scale functions
                        console.log("prostitution:")
                        var xScale = d3.scale.linear()
                            .domain([0, max_prostitution * 1.15])
                            .range([padding, w - padding * 2]);

                        console.log("vehicle:")
                        var yScale = d3.scale.linear()
                            .domain([0, max_vehicle * 1.1])
                            .range([h - padding, padding]);

                        console.log("total:")
                        var rScale = d3.scale.linear()
                            .domain([0, d3.max(dataset_2003, function(d) { console.log(d.total); return parseInt(d.total); })])
                            .range([0,max_radius]);

                        //Define X axis
                        var xAxis = d3.svg.axis()
                            .scale(xScale)
                            .orient("bottom")
                            .ticks(8);

                        //Define Y axis
                        var yAxis = d3.svg.axis()
                                    .scale(yScale)
                                    .orient("left")
                                    .ticks(8);

                        //Create SVG element
                        var svg1 = d3.select("#area1")
                            .append("svg")
                            .attr("width", w)
                            .attr("height", h);

                        //Define clipping path
                        svg1.append("clipPath")
                            .attr("id", "chart-area")
                            .append("rect")
                            .attr("x", padding)
                            .attr("y", padding)
                            .attr("width", w - padding * 3)
                            .attr("height", h - padding * 2);

                        //Create circles
                        svg1.append("g")
                            .attr("id", "circles")
                            .attr("clip-path", "url(#chart-area)")
                            .selectAll("circle")
                            .data(dataset_2003)
                            .enter()
                            .append("circle")
                            .attr("cx", function(d) {
                                return xScale(d.prostitution);
                            })
                            .attr("cy", function(d) {
                                return yScale(d.vehicle);
                            })
                            .attr("r", function(d) {
                                 return rScale(d.total);
                            });
                      
                        //Create X axis
                        svg1.append("g")
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + (h - padding) + ")")
                            .call(xAxis);
                      
                        //Create Y axis
                        svg1.append("g")
                            .attr("class", "y axis")
                            .attr("transform", "translate(" + padding + ",0)")
                            .call(yAxis);
                      

                        svg1.append("g")
                            .attr("id", "texts")
                            .attr("clip-path", "url(#chart-area)")
                            .selectAll("text")
                            .data(dataset_2003)
                            .enter()
                            .append("text")
                            .attr("class", "labels")
                            .text(function(d) {
                                return d.District;
                            })
                            .attr("x", function(d) {
                                return xScale(d.prostitution);
                            })
                            .attr("y", function(d) {
                                 return yScale(d.vehicle);
                            })
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "10px")
                            .attr("fill", primaryColor);


                        // now add titles to the axes
                        svg1.append("text")
                            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                            .attr("transform", "translate("+ (padding/3) +","+(h/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
                            .text("Theft");

                        svg1.append("text")
                            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                            .attr("transform", "translate("+ (w/2) +","+(h-(padding/3))+")")  // centre below axis
                            .text("Prostitution");

                        d3.selectAll("p").filter("#data2003").style("color",primaryColor);


                        d3.selectAll("p")
                            .filter(".p_data_1")
                            .on("click", function() {

                            // Get button 2003 and 2015
                            var p_2003 = d3.selectAll("p").filter("#data2003");
                            var p_2015 = d3.selectAll("p").filter("#data2015"); 

                            var paragraphID = d3.select(this).attr("id");
                            var chosenDataset;

                            if(paragraphID == "data2003"){
                                chosenDataset = dataset_2003;
                                p_2003.style("color", primaryColor);
                                p_2015.style("color", "black");
                                console.log("2003 button pressed")
                            }
                            else {
                                chosenDataset = dataset_2015;
                                p_2003.style("color", "black");
                                p_2015.style("color", primaryColor);
                                console.log("2015 button pressed")
                            }
                          
                            var transition_duration = 1000;

                            // Update radius scaling
                            rScale.domain([0, d3.max(chosenDataset, function(d) { console.log(d.total); return parseInt(d.total); })]);

                            //Update all circles
                            svg1.selectAll("circle")
                                .data(chosenDataset)
                                .transition()
                                .duration(transition_duration)
                                .attr("cx", function(d) {
                                    return xScale(d.prostitution);
                                })
                                .attr("cy", function(d) {
                                    return yScale(d.vehicle);
                                })
                                .attr("r", function(d) {
                                    return rScale(d.total);
                                });

                            //Update all Text
                            svg1.selectAll("text")
                                .filter(".labels")
                                .data(chosenDataset)
                                .transition()
                                .duration(transition_duration)
                                .attr("x", function(d) {
                                    return xScale(d.prostitution);
                                })
                                .attr("y", function(d) {
                                    return yScale(d.vehicle);
                                });
                        });
                    }
                });
            </script>


            <!-- EXERCISE 2 SCRIPT -->

            <script type="text/javascript"> 
                //Width and height
                var w = 800;
                var h = 600;
                var k = 2;
                var  data_2;
                var locations;

                var primaryColor = "rgba(135,206,235,1)"

                var projection = d3.geo.mercator()
                    .center([-122.433701, 37.767683])
                    .scale(200000)
                    .translate([w / 2, h / 2]);

                //Define path generator
                var path = d3.geo.path()
                    .projection(projection);

                //Define quantize scale to sort data values into buckets of color
                var color = d3.scale.quantize()
                    .domain(d3.range(6))
                    .range(["yellow","pink","green","red","orange","black"]);

                //Create SVG element
                var svg = d3.select("#area3")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

                //Load in GeoJSON data
                d3.json("https://raw.githubusercontent.com/suneman/socialdataanalysis2017/master/files/sfpddistricts.geojson", function(json){
                //d3.json("us-states.json", function(json) {                    
                    //Bind data and create one path per GeoJSON feature
                    svg.selectAll("path")
                       .data(json.features)
                       .enter()
                       .append("path")
                       .attr("d", path)
                       .style("fill", "steelblue");

                    d3.json("data/data2.json", function(error,json) {
                        if (error) {  //If error is not null, something went wrong.
                            console.log(error);  //Log the error.
                        } 
                        else {  
                            //If no error, the file loaded correctly. Yay!
                            //console.log(json);  //Log the data.
                            data_2 = json;
                            console.log(data_2);
                            locations = data_2.locations;

                            svg.selectAll("circle")
                               .data(data_2.knn2.data)
                               .enter()
                               .append("circle")
                               .attr("cx", function(d,i) {
                                    var lat = locations[i][0];
                                    var lon = locations[i][1]
                                    return projection([lon, lat])[0];
                               })
                               .attr("cy", function(d,i) {
                                    var lat = locations[i][0];
                                    var lon = locations[i][1]
                                    return projection([lon, lat])[1];
                               })
                               .attr("r", 3)
                               .style("fill", function(d) {
                                    return color(d);
                               })
                               .style("opacity", 0.75);

                            d3.selectAll("p").filter("#knn2").style("color",primaryColor);
                            d3.selectAll("p")
                                .filter(".p_knn")
                                .on("click", function() {
                                    setcolor_knn_p();
                                    var paragraphID = d3.select(this).attr("id");

                                    d3.selectAll("p")
                                        .filter("#"+paragraphID)
                                        .style("color", primaryColor);

                                    var class_data = getdata_by_class_knn(data_2, paragraphID);
                                    console.log(class_data);

                                    //Update all circles
                                    svg.selectAll("circle")
                                        .data(class_data.data)
                                        .transition()
                                        .duration(1000)
                                        .attr("r",3)
                                        .style("fill", function(d) {
                                            return color(d);
                                        });

                                });
                        }   
                    });
                });

                function setcolor_knn_p() {
                    d3.selectAll("p")
                        .filter(".p_knn")
                        .style("color", "black");
                }

                function getdata_by_class_knn(data,knn_class){
                    if(knn_class == "knn2"){
                        return data.knn2;
                    }
                    if(knn_class == "knn3"){
                        return data.knn3;
                    }
                    if(knn_class == "knn4"){
                        return data.knn4;
                    }
                    if(knn_class == "knn5"){
                        return data.knn5;
                    }
                    if(knn_class == "knn6"){
                        return data.knn6;
                    }
                }
            </script>
        </body>
</html>